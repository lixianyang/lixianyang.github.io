<!DOCTYPE html>
<html lang="CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>kubernetes 源码阅读之 client-go 源码结构与客户端对象 - 李斯文的笔记本</title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="kubernetes 源码阅读之 client-go 源码结构与客户端对象" />
<meta property="og:description" content="client-go 介绍 Kubernetes 系统使用 client-go 作为 go 语言的官方编程式交互客户端库，提供对 Kubernetes API Server 服务的交互访问。开发者常使用 client-go 基于 Kubernetes 做二次开发，所以 client-go 是开发者应熟练掌握的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lixianyang.github.io/posts/client-go-source-code/" />
<meta property="article:published_time" content="2020-08-09T23:40:31+08:00" />
<meta property="article:modified_time" content="2020-08-09T23:40:31+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes 源码阅读之 client-go 源码结构与客户端对象"/>
<meta name="twitter:description" content="client-go 介绍 Kubernetes 系统使用 client-go 作为 go 语言的官方编程式交互客户端库，提供对 Kubernetes API Server 服务的交互访问。开发者常使用 client-go 基于 Kubernetes 做二次开发，所以 client-go 是开发者应熟练掌握的"/>
<meta name="application-name" content="李斯文">
<meta name="apple-mobile-web-app-title" content="李斯文"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://lixianyang.github.io/posts/client-go-source-code/" /><link rel="prev" href="https://lixianyang.github.io/posts/%E5%8A%9E%E5%85%AC%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "kubernetes 源码阅读之 client-go 源码结构与客户端对象",
        "inLanguage": "CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lixianyang.github.io\/posts\/client-go-source-code\/"
        },"genre": "posts","keywords": "k8s, client-go","wordcount":  4840 ,
        "url": "https:\/\/lixianyang.github.io\/posts\/client-go-source-code\/","datePublished": "2020-08-09T23:40:31+08:00","dateModified": "2020-08-09T23:40:31+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "李斯文"
            },"description": ""
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="李斯文的笔记本"><span id="id-1" class="typeit"></span><span class="header-title-post">^_^</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/" title="关于"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="李斯文的笔记本"><span id="id-2" class="typeit"></span><span class="header-title-post">^_^</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="关于">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">kubernetes 源码阅读之 client-go 源码结构与客户端对象</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>李斯文</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes/"><i class="far fa-folder fa-fw"></i>Kubernetes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-08-09">2020-08-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4840 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id="/posts/client-go-source-code/" class="leancloud_visitors" data-flag-title="kubernetes 源码阅读之 client-go 源码结构与客户端对象">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#client-go-介绍">client-go 介绍</a></li>
    <li><a href="#源码目录">源码目录</a></li>
    <li><a href="#客户端对象">客户端对象</a>
      <ul>
        <li><a href="#客户端配置-restconfig">客户端配置 <code>rest.Config</code></a>
          <ul>
            <li><a href="#clientconfig-接口">ClientConfig 接口</a></li>
            <li><a href="#获取的逻辑">获取的逻辑</a></li>
          </ul>
        </li>
        <li><a href="#restclient">RESTClient</a>
          <ul>
            <li><a href="#restclient-结构"><code>RESTClient</code> 结构</a></li>
            <li><a href="#request-结构"><code>Request</code> 结构</a></li>
            <li><a href="#使用示例">使用示例</a></li>
          </ul>
        </li>
        <li><a href="#clientset">ClientSet</a>
          <ul>
            <li><a href="#创建-client">创建 client</a></li>
            <li><a href="#使用示例-1">使用示例</a></li>
          </ul>
        </li>
        <li><a href="#dynamicclient">DynamicClient</a>
          <ul>
            <li><a href="#创建-client-1">创建 client</a></li>
            <li><a href="#使用示例-2">使用示例</a></li>
          </ul>
        </li>
        <li><a href="#discoveryclient">DiscoveryClient</a></li>
        <li><a href="#scaleclient">ScaleClient</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="client-go-介绍">client-go 介绍</h2>
<p>Kubernetes 系统使用 <code>client-go</code> 作为 go 语言的官方编程式交互客户端库，提供对 Kubernetes API Server 服务的交互访问。开发者常使用 <code>client-go</code> 基于 Kubernetes 做二次开发，所以 <code>client-go</code> 是开发者应熟练掌握的技能。</p>
<p>下面是环境版本等信息</p>
<ul>
<li>系统：Ubuntu 20.04.1 LTS</li>
<li>Kubernetes Branch: release-1.14</li>
<li>Golang Version: 1.14.7</li>
<li>Goland Version: 2020.2</li>
</ul>
<h2 id="源码目录">源码目录</h2>
<p><code>client-go</code> 源码目录如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lee@u:~/go/src/k8s.io/kubernetes/staging/src/k8s.io/client-go$ tree -L <span class="m">1</span> -d
.
├── deprecated-dynamic  <span class="c1"># 废弃</span>
├── discovery           <span class="c1"># 提供 DiscoveryClient 发现客户端</span>
├── dynamic             <span class="c1"># 提供 DynamicClient 动态客户端</span>
├── examples            <span class="c1"># client-go 使用示例</span>
├── Godeps              <span class="c1"># 包含 godep 自动生成的文件，忽略</span>
├── informers           <span class="c1"># 每种 Kubernetes 资源的 Informer 实现</span>
├── kubernetes          <span class="c1"># 提供 ClientSet 客户端</span>
├── kubernetes_test     <span class="c1"># ClientSet 测试</span>
├── listers             <span class="c1"># 为每一种 Kubernetes 资源提供 Lister 功能，该功能对 Get 和 List 请求提供只读的缓存数据</span>
├── pkg
├── plugin              <span class="c1"># 提供 OpenStack, Azure 等云服务商授权插件</span>
├── rest                <span class="c1"># 提供 RESTClient，封装对 Kubernetes API Server 的 RESTful 操作</span>
├── restmapper
├── scale               <span class="c1"># 提供 ScaleClient 客户端，用于扩缩容</span>
├── testing
├── third_party
├── tools               <span class="c1"># 提供常用工具</span>
├── transport           <span class="c1"># 提供安全的 TCP 连接，支持 Http Stream</span>
└── util                <span class="c1"># 提供常用方法</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="客户端对象">客户端对象</h2>
<p>在讲客户端之前，我们先来看看初始化客户端需要的配置 <code>rest.Config</code></p>
<h3 id="客户端配置-restconfig">客户端配置 <code>rest.Config</code></h3>
<p><em>staging/src/k8s.io/client-go/rest/config.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// Config holds the common attributes that can be passed to a Kubernetes client on
</span><span class="c1">// initialization.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Host must be a host string, a host:port pair, or a URL to the base of the apiserver.
</span><span class="c1"></span>	<span class="c1">// If a URL is given then the (optional) Path of that URL represents a prefix that must
</span><span class="c1"></span>	<span class="c1">// be appended to all request URIs used to access the apiserver. This allows a frontend
</span><span class="c1"></span>	<span class="c1">// proxy to easily relocate all of the apiserver endpoints.
</span><span class="c1"></span>	<span class="nx">Host</span> <span class="kt">string</span>
	<span class="c1">// APIPath is a sub-path that points to an API root.
</span><span class="c1"></span>	<span class="nx">APIPath</span> <span class="kt">string</span>

	<span class="c1">// ContentConfig contains settings that affect how objects are transformed when
</span><span class="c1"></span>	<span class="c1">// sent to the server.
</span><span class="c1"></span>	<span class="nx">ContentConfig</span>

	<span class="c1">// Server requires Basic authentication
</span><span class="c1"></span>	<span class="nx">Username</span> <span class="kt">string</span>
	<span class="nx">Password</span> <span class="kt">string</span>

	<span class="c1">// Server requires Bearer authentication. This client will not attempt to use
</span><span class="c1"></span>	<span class="c1">// refresh tokens for an OAuth2 flow.
</span><span class="c1"></span>	<span class="c1">// TODO: demonstrate an OAuth2 compatible client.
</span><span class="c1"></span>	<span class="nx">BearerToken</span> <span class="kt">string</span>

	<span class="c1">// Path to a file containing a BearerToken.
</span><span class="c1"></span>	<span class="c1">// If set, the contents are periodically read.
</span><span class="c1"></span>	<span class="c1">// The last successfully read value takes precedence over BearerToken.
</span><span class="c1"></span>	<span class="nx">BearerTokenFile</span> <span class="kt">string</span>

	<span class="c1">// Impersonate is the configuration that RESTClient will use for impersonation.
</span><span class="c1"></span>	<span class="nx">Impersonate</span> <span class="nx">ImpersonationConfig</span>

	<span class="c1">// Server requires plugin-specified authentication.
</span><span class="c1"></span>	<span class="nx">AuthProvider</span> <span class="o">*</span><span class="nx">clientcmdapi</span><span class="p">.</span><span class="nx">AuthProviderConfig</span>

	<span class="c1">// Callback to persist config for AuthProvider.
</span><span class="c1"></span>	<span class="nx">AuthConfigPersister</span> <span class="nx">AuthProviderConfigPersister</span>

	<span class="c1">// Exec-based authentication provider.
</span><span class="c1"></span>	<span class="nx">ExecProvider</span> <span class="o">*</span><span class="nx">clientcmdapi</span><span class="p">.</span><span class="nx">ExecConfig</span>

	<span class="c1">// TLSClientConfig contains settings to enable transport layer security
</span><span class="c1"></span>	<span class="nx">TLSClientConfig</span>

	<span class="c1">// UserAgent is an optional field that specifies the caller of this request.
</span><span class="c1"></span>	<span class="nx">UserAgent</span> <span class="kt">string</span>

	<span class="c1">// Transport may be used for custom HTTP behavior. This attribute may not
</span><span class="c1"></span>	<span class="c1">// be specified with the TLS client certificate options. Use WrapTransport
</span><span class="c1"></span>	<span class="c1">// to provide additional per-server middleware behavior.
</span><span class="c1"></span>	<span class="nx">Transport</span> <span class="nx">http</span><span class="p">.</span><span class="nx">RoundTripper</span>
	<span class="c1">// WrapTransport will be invoked for custom HTTP behavior after the underlying
</span><span class="c1"></span>	<span class="c1">// transport is initialized (either the transport created from TLSClientConfig,
</span><span class="c1"></span>	<span class="c1">// Transport, or http.DefaultTransport). The config may layer other RoundTrippers
</span><span class="c1"></span>	<span class="c1">// on top of the returned RoundTripper.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// A future release will change this field to an array. Use config.Wrap()
</span><span class="c1"></span>	<span class="c1">// instead of setting this value directly.
</span><span class="c1"></span>	<span class="nx">WrapTransport</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">WrapperFunc</span>

	<span class="c1">// QPS indicates the maximum QPS to the master from this client.
</span><span class="c1"></span>	<span class="c1">// If it&#39;s zero, the created RESTClient will use DefaultQPS: 5
</span><span class="c1"></span>	<span class="nx">QPS</span> <span class="kt">float32</span>

	<span class="c1">// Maximum burst for throttle.
</span><span class="c1"></span>	<span class="c1">// If it&#39;s zero, the created RESTClient will use DefaultBurst: 10.
</span><span class="c1"></span>	<span class="nx">Burst</span> <span class="kt">int</span>

	<span class="c1">// Rate limiter for limiting connections to the master from this client. If present overwrites QPS/Burst
</span><span class="c1"></span>	<span class="nx">RateLimiter</span> <span class="nx">flowcontrol</span><span class="p">.</span><span class="nx">RateLimiter</span>

	<span class="c1">// The maximum length of time to wait before giving up on a server request. A value of zero means no timeout.
</span><span class="c1"></span>	<span class="nx">Timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

	<span class="c1">// Dial specifies the dial function for creating unencrypted TCP connections.
</span><span class="c1"></span>	<span class="nx">Dial</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">network</span><span class="p">,</span> <span class="nx">address</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Version forces a specific version to be used (if registered)
</span><span class="c1"></span>	<span class="c1">// Do we need this?
</span><span class="c1"></span>	<span class="c1">// Version string
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以调用 <code>BuildConfigFromFlags</code> 函数获取 <code>rest.Config</code> 对象</p>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/client_config.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// BuildConfigFromFlags is a helper function that builds configs from a master
</span><span class="c1">// url or a kubeconfig filepath. These are passed in as command line flags for cluster
</span><span class="c1">// components. Warnings should reflect this usage. If neither masterUrl or kubeconfigPath
</span><span class="c1">// are passed in we fallback to inClusterConfig. If inClusterConfig fails, we fallback
</span><span class="c1">// to the default config.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="nx">masterUrl</span><span class="p">,</span> <span class="nx">kubeconfigPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">restclient</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">kubeconfigPath</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">masterUrl</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.&#34;</span><span class="p">)</span>
		<span class="nx">kubeconfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">restclient</span><span class="p">.</span><span class="nf">InClusterConfig</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">kubeconfig</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;error creating inClusterConfig, falling back to default config: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nf">NewNonInteractiveDeferredLoadingClientConfig</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="nx">ClientConfigLoadingRules</span><span class="p">{</span><span class="nx">ExplicitPath</span><span class="p">:</span> <span class="nx">kubeconfigPath</span><span class="p">},</span>
		<span class="o">&amp;</span><span class="nx">ConfigOverrides</span><span class="p">{</span><span class="nx">ClusterInfo</span><span class="p">:</span> <span class="nx">clientcmdapi</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">{</span><span class="nx">Server</span><span class="p">:</span> <span class="nx">masterUrl</span><span class="p">}}).</span><span class="nf">ClientConfig</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果 <code>masterUrl</code>, <code>kubeconfigPath</code> 都不传，则会使用集群内的配置 <code>InClusterConfig</code></p>
<p><em>staging/src/k8s.io/client-go/rest/config.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// InClusterConfig returns a config object which uses the service account
</span><span class="c1">// kubernetes gives to pods. It&#39;s intended for clients that expect to be
</span><span class="c1">// running inside a pod running on kubernetes. It will return ErrNotInCluster
</span><span class="c1">// if called from a process not running in a kubernetes environment.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">InClusterConfig</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="p">(</span>
		<span class="nx">tokenFile</span>  <span class="p">=</span> <span class="s">&#34;/var/run/secrets/kubernetes.io/serviceaccount/token&#34;</span>
		<span class="nx">rootCAFile</span> <span class="p">=</span> <span class="s">&#34;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&#34;</span>
	<span class="p">)</span>
	<span class="nx">host</span><span class="p">,</span> <span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;KUBERNETES_SERVICE_HOST&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;KUBERNETES_SERVICE_PORT&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrNotInCluster</span>
	<span class="p">}</span>

	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">tokenFile</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">tlsClientConfig</span> <span class="o">:=</span> <span class="nx">TLSClientConfig</span><span class="p">{}</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">certutil</span><span class="p">.</span><span class="nf">NewPool</span><span class="p">(</span><span class="nx">rootCAFile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected to load root CA config from %s, but got err: %v&#34;</span><span class="p">,</span> <span class="nx">rootCAFile</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">tlsClientConfig</span><span class="p">.</span><span class="nx">CAFile</span> <span class="p">=</span> <span class="nx">rootCAFile</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span>
		<span class="c1">// TODO: switch to using cluster DNS.
</span><span class="c1"></span>		<span class="nx">Host</span><span class="p">:</span>            <span class="s">&#34;https://&#34;</span> <span class="o">+</span> <span class="nx">net</span><span class="p">.</span><span class="nf">JoinHostPort</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">),</span>
		<span class="nx">TLSClientConfig</span><span class="p">:</span> <span class="nx">tlsClientConfig</span><span class="p">,</span>
		<span class="nx">BearerToken</span><span class="p">:</span>     <span class="nb">string</span><span class="p">(</span><span class="nx">token</span><span class="p">),</span>
		<span class="nx">BearerTokenFile</span><span class="p">:</span> <span class="nx">tokenFile</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>否则的话，通过 <code>ClientConfig</code> 获取 <code>rest.Config</code>。下面详细解释。</p>
<h4 id="clientconfig-接口">ClientConfig 接口</h4>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/client_config.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// ClientConfig is used to make it easy to get an api server client
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ClientConfig</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// RawConfig returns the merged result of all overrides
</span><span class="c1"></span>	<span class="nf">RawConfig</span><span class="p">()</span> <span class="p">(</span><span class="nx">clientcmdapi</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// ClientConfig returns a complete client config
</span><span class="c1"></span>	<span class="nf">ClientConfig</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">restclient</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Namespace returns the namespace resulting from the merged
</span><span class="c1"></span>	<span class="c1">// result of all overrides and a boolean indicating if it was
</span><span class="c1"></span>	<span class="c1">// overridden
</span><span class="c1"></span>	<span class="nf">Namespace</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// ConfigAccess returns the rules for loading/persisting the config.
</span><span class="c1"></span>	<span class="nf">ConfigAccess</span><span class="p">()</span> <span class="nx">ConfigAccess</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>DeferredLoadingClientConfig</code>, <code>DirectClientConfig</code>, <code>inClusterClientConfig</code> 三个结构体实现了 <code>ClientConfig</code> 接口。</p>
<h4 id="获取的逻辑">获取的逻辑</h4>
<p>前面 <code>BuildConfigFromFlags</code> 函数最后调用 <code>NewNonInteractiveDeferredLoadingClientConfig</code> 函数，实际上返回的是 <code>DeferredLoadingClientConfig</code> 对象。</p>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/merged_client_builder.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// NewNonInteractiveDeferredLoadingClientConfig creates a ConfigClientClientConfig using the passed context name
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewNonInteractiveDeferredLoadingClientConfig</span><span class="p">(</span><span class="nx">loader</span> <span class="nx">ClientConfigLoader</span><span class="p">,</span> <span class="nx">overrides</span> <span class="o">*</span><span class="nx">ConfigOverrides</span><span class="p">)</span> <span class="nx">ClientConfig</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">DeferredLoadingClientConfig</span><span class="p">{</span><span class="nx">loader</span><span class="p">:</span> <span class="nx">loader</span><span class="p">,</span> <span class="nx">overrides</span><span class="p">:</span> <span class="nx">overrides</span><span class="p">,</span> <span class="nx">icc</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">inClusterClientConfig</span><span class="p">{</span><span class="nx">overrides</span><span class="p">:</span> <span class="nx">overrides</span><span class="p">}}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>获取 <code>rest.Config</code> 的核心逻辑在 <code>DeferredLoadingClientConfig</code> 的 <code>ClientConfig</code> 方法中。</p>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/merged_client_builder.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// ClientConfig implements ClientConfig
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">DeferredLoadingClientConfig</span><span class="p">)</span> <span class="nf">ClientConfig</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">restclient</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mergedClientConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">createClientConfig</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// load the configuration and return on non-empty errors and if the
</span><span class="c1"></span>	<span class="c1">// content differs from the default config
</span><span class="c1"></span>	<span class="nx">mergedConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mergedClientConfig</span><span class="p">.</span><span class="nf">ClientConfig</span><span class="p">()</span>
	<span class="k">switch</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">!</span><span class="nf">IsEmptyConfig</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// return on any error except empty config
</span><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="nx">mergedConfig</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
		<span class="c1">// the configuration is valid, but if this is equal to the defaults we should try
</span><span class="c1"></span>		<span class="c1">// in-cluster configuration
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nf">IsDefaultConfig</span><span class="p">(</span><span class="nx">mergedConfig</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">mergedConfig</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// check for in-cluster configuration and use it
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">icc</span><span class="p">.</span><span class="nf">Possible</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Using in-cluster configuration&#34;</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">config</span><span class="p">.</span><span class="nx">icc</span><span class="p">.</span><span class="nf">ClientConfig</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="c1">// return the result of the merged client config
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">mergedConfig</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>不难发现，<code>config.createClientConfig()</code> 创建了一个满足 <code>ClientConfig</code> 接口的对象，然后调用该对象的 <code>ClientConfig()</code> 方法获取到的 <code>rest.Config</code> 对象。所以核心逻辑是在 <code>mergedClientConfig</code> 对象的 <code>ClientConfig</code> 方法里。 下面我们看看 <code>createClientConfig</code> 方法。</p>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/merged_client_builder.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">DeferredLoadingClientConfig</span><span class="p">)</span> <span class="nf">createClientConfig</span><span class="p">()</span> <span class="p">(</span><span class="nx">ClientConfig</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientConfig</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">loadingLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
		<span class="k">defer</span> <span class="nx">config</span><span class="p">.</span><span class="nx">loadingLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientConfig</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">mergedConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>

			<span class="kd">var</span> <span class="nx">mergedClientConfig</span> <span class="nx">ClientConfig</span>
			<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">fallbackReader</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">mergedClientConfig</span> <span class="p">=</span> <span class="nf">NewInteractiveClientConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">mergedConfig</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">.</span><span class="nx">CurrentContext</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">fallbackReader</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">loader</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">mergedClientConfig</span> <span class="p">=</span> <span class="nf">NewNonInteractiveClientConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">mergedConfig</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">.</span><span class="nx">CurrentContext</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">loader</span><span class="p">)</span>
			<span class="p">}</span>

			<span class="nx">config</span><span class="p">.</span><span class="nx">clientConfig</span> <span class="p">=</span> <span class="nx">mergedClientConfig</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientConfig</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>核心逻辑：</p>
<ol>
<li>调用 <code>config.loader.Load()</code> 通过 <code>ClientConfigLoadingRules</code> 对象的 Load 方法加载合并配置，返回 <code>clientcmdapi.Config</code>。</li>
<li>调用 <code>NewInteractiveClientConfig</code> 或 <code>NewNonInteractiveClientConfig</code> 方法，返回 <code>DirectClientConfig</code> 对象。</li>
</ol>
<p>所以上面 <code>mergedClientConfig.ClientConfig()</code> 实际上调用的是 <code>DirectClientConfig</code> 对象的 <code>ClientConfig()</code> 方法，源码如下：</p>
<p><em>staging/src/k8s.io/client-go/tools/clientcmd/client_config.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// ClientConfig implements ClientConfig
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">DirectClientConfig</span><span class="p">)</span> <span class="nf">ClientConfig</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">restclient</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// check that getAuthInfo, getContext, and getCluster do not return an error.
</span><span class="c1"></span>	<span class="c1">// Do this before checking if the current config is usable in the event that an
</span><span class="c1"></span>	<span class="c1">// AuthInfo, Context, or Cluster config with user-defined names are not found.
</span><span class="c1"></span>	<span class="c1">// This provides a user with the immediate cause for error if one is found
</span><span class="c1"></span>	<span class="nx">configAuthInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">getAuthInfo</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">getContext</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">configClusterInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">getCluster</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ConfirmUsable</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">clientConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">restclient</span><span class="p">.</span><span class="nx">Config</span><span class="p">{}</span>
	<span class="nx">clientConfig</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="nx">configClusterInfo</span><span class="p">.</span><span class="nx">Server</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">timeout</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ParseTimeout</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">overrides</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">clientConfig</span><span class="p">.</span><span class="nx">Timeout</span> <span class="p">=</span> <span class="nx">timeout</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">ParseRequestURI</span><span class="p">(</span><span class="nx">clientConfig</span><span class="p">.</span><span class="nx">Host</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Opaque</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">u</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
		<span class="nx">u</span><span class="p">.</span><span class="nx">Fragment</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
		<span class="nx">clientConfig</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">configAuthInfo</span><span class="p">.</span><span class="nx">Impersonate</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">clientConfig</span><span class="p">.</span><span class="nx">Impersonate</span> <span class="p">=</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">ImpersonationConfig</span><span class="p">{</span>
			<span class="nx">UserName</span><span class="p">:</span> <span class="nx">configAuthInfo</span><span class="p">.</span><span class="nx">Impersonate</span><span class="p">,</span>
			<span class="nx">Groups</span><span class="p">:</span>   <span class="nx">configAuthInfo</span><span class="p">.</span><span class="nx">ImpersonateGroups</span><span class="p">,</span>
			<span class="nx">Extra</span><span class="p">:</span>    <span class="nx">configAuthInfo</span><span class="p">.</span><span class="nx">ImpersonateUserExtra</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// only try to read the auth information if we are secure
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">restclient</span><span class="p">.</span><span class="nf">IsConfigTransportTLS</span><span class="p">(</span><span class="o">*</span><span class="nx">clientConfig</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
		<span class="kd">var</span> <span class="nx">persister</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">AuthProviderConfigPersister</span>
		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">configAccess</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">authInfoName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">getAuthInfoName</span><span class="p">()</span>
			<span class="nx">persister</span> <span class="p">=</span> <span class="nf">PersisterForUser</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">configAccess</span><span class="p">,</span> <span class="nx">authInfoName</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">userAuthPartialConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">getUserIdentificationPartialConfig</span><span class="p">(</span><span class="nx">configAuthInfo</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">fallbackReader</span><span class="p">,</span> <span class="nx">persister</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">mergo</span><span class="p">.</span><span class="nf">MergeWithOverwrite</span><span class="p">(</span><span class="nx">clientConfig</span><span class="p">,</span> <span class="nx">userAuthPartialConfig</span><span class="p">)</span>

		<span class="nx">serverAuthPartialConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getServerIdentificationPartialConfig</span><span class="p">(</span><span class="nx">configAuthInfo</span><span class="p">,</span> <span class="nx">configClusterInfo</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">mergo</span><span class="p">.</span><span class="nf">MergeWithOverwrite</span><span class="p">(</span><span class="nx">clientConfig</span><span class="p">,</span> <span class="nx">serverAuthPartialConfig</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">clientConfig</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，该函数内部初始化了 <code>rest.Config</code> 对象，并返回。</p>
<h3 id="restclient">RESTClient</h3>
<p><code>RESTClient</code> 是最基础的客户端。其他的客户端都是基于 <code>RESTClient</code> 实现的。<code>RESTClient</code> 对 HTTP Request 进行了封装，实现了 RESTful 风格的 API。它具有很高的灵活性，数据不依赖于方法和资源，因此 <code>RESTClient</code> 能够处理多种类型的调用，返回不同的数据格式。</p>
<h4 id="restclient-结构"><code>RESTClient</code> 结构</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://lixianyang.oss-cn-beijing.aliyuncs.com/github/RESTClient-Tree.webp"
        data-srcset="https://lixianyang.oss-cn-beijing.aliyuncs.com/github/RESTClient-Tree.webp, https://lixianyang.oss-cn-beijing.aliyuncs.com/github/RESTClient-Tree.webp 1.5x, https://lixianyang.oss-cn-beijing.aliyuncs.com/github/RESTClient-Tree.webp 2x"
        data-sizes="auto"
        alt="https://lixianyang.oss-cn-beijing.aliyuncs.com/github/RESTClient-Tree.webp"
        title="RESTClient Tree" /></p>
<p>有 3 个函数可以用来创建 <code>RESTClient</code> 对象，后面两个都是调用 <code>NewRESTClient</code> 来创建的。</p>
<ol>
<li>NewRESTClient(&hellip;) (*RESTClient, error)</li>
<li>RESTClientFor(config *Config) (*RESTClient, error)</li>
<li>UnversionedRESTClientFor(config *Config) (*RESTClient, error)</li>
</ol>
<p><code>Get</code>, <code>POST</code>, <code>PATCH</code> 等方法会调用 <code>Verb</code> 方法，返回的都是 <code>Request</code> 对象。理解 <code>Request</code> 对象是理解 <code>RESTClient</code> 的关键。</p>
<h4 id="request-结构"><code>Request</code> 结构</h4>
<p><code>Request</code> 允许以链式方式构建到服务器的请求。最终通过 <code>Do</code> 方法调用。</p>
<p><em>staging/src/k8s.io/client-go/rest/request.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// Do formats and executes the request. Returns a Result object for easy response
</span><span class="c1">// processing.
</span><span class="c1">//
</span><span class="c1">// Error type:
</span><span class="c1">//  * If the request can&#39;t be constructed, or an error happened earlier while building its
</span><span class="c1">//    arguments: *RequestConstructionError
</span><span class="c1">//  * If the server responds with a status: *errors.StatusError or *errors.UnexpectedObjectError
</span><span class="c1">//  * http.Client.Do errors are returned directly.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="nf">Do</span><span class="p">()</span> <span class="nx">Result</span> <span class="p">{</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">tryThrottle</span><span class="p">()</span>

	<span class="kd">var</span> <span class="nx">result</span> <span class="nx">Result</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">result</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">transformResponse</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">Result</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Do</code> 方法调用了 <code>request</code> 方法</p>
<p><em>staging/src/k8s.io/client-go/rest/request.go</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// request connects to the server and invokes the provided function when a server response is
</span><span class="c1">// received. It handles retry behavior and up front validation of requests. It will invoke
</span><span class="c1">// fn at most once. It will return an error if a problem occurred prior to connecting to the
</span><span class="c1">// server - the provided function is responsible for handling server errors.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="nf">request</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">))</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">//Metrics for total request latency
</span><span class="c1"></span>	<span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">metrics</span><span class="p">.</span><span class="nx">RequestLatency</span><span class="p">.</span><span class="nf">Observe</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">finalURLTemplate</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
	<span class="p">}()</span>

	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Error in request: %v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// TODO: added to catch programmer errors (invoking operations with an object with an empty namespace)
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span> <span class="o">==</span> <span class="s">&#34;GET&#34;</span> <span class="o">||</span> <span class="nx">r</span><span class="p">.</span><span class="nx">verb</span> <span class="o">==</span> <span class="s">&#34;PUT&#34;</span> <span class="o">||</span> <span class="nx">r</span><span class="p">.</span><span class="nx">verb</span> <span class="o">==</span> <span class="s">&#34;DELETE&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">namespaceSet</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">resourceName</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">namespace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;an empty namespace may not be set when a resource name is provided&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span> <span class="o">==</span> <span class="s">&#34;POST&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">namespaceSet</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">namespace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;an empty namespace may not be set during creation&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">client</span>
	<span class="k">if</span> <span class="nx">client</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">client</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">DefaultClient</span>
	<span class="p">}</span>

	<span class="c1">// Right now we make about ten retry attempts if we get a Retry-After response.
</span><span class="c1"></span>	<span class="nx">maxRetries</span> <span class="o">:=</span> <span class="mi">10</span>
	<span class="nx">retries</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">url</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">URL</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
		<span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="kd">var</span> <span class="nx">cancelFn</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span>
			<span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancelFn</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span>
			<span class="k">defer</span> <span class="nf">cancelFn</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">headers</span>

		<span class="nx">r</span><span class="p">.</span><span class="nx">backoffMgr</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">backoffMgr</span><span class="p">.</span><span class="nf">CalculateBackoff</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">URL</span><span class="p">()))</span>
		<span class="k">if</span> <span class="nx">retries</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="c1">// We are retrying the request that we already send to apiserver
</span><span class="c1"></span>			<span class="c1">// at least once before.
</span><span class="c1"></span>			<span class="c1">// This request should also be throttled with the client-internal throttler.
</span><span class="c1"></span>			<span class="nx">r</span><span class="p">.</span><span class="nf">tryThrottle</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
		<span class="nf">updateURLMetrics</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">r</span><span class="p">.</span><span class="nx">backoffMgr</span><span class="p">.</span><span class="nf">UpdateBackoff</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">URL</span><span class="p">(),</span> <span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">r</span><span class="p">.</span><span class="nx">backoffMgr</span><span class="p">.</span><span class="nf">UpdateBackoff</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">URL</span><span class="p">(),</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// &#34;Connection reset by peer&#34; is usually a transient error.
</span><span class="c1"></span>			<span class="c1">// Thus in case of &#34;GET&#34; operations, we simply retry it.
</span><span class="c1"></span>			<span class="c1">// We are not automatically retrying &#34;write&#34; operations, as
</span><span class="c1"></span>			<span class="c1">// they are not idempotent.
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">!</span><span class="nx">net</span><span class="p">.</span><span class="nf">IsConnectionReset</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">||</span> <span class="nx">r</span><span class="p">.</span><span class="nx">verb</span> <span class="o">!=</span> <span class="s">&#34;GET&#34;</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="c1">// For the purpose of retry, we set the artificial &#34;retry-after&#34; response.
</span><span class="c1"></span>			<span class="c1">// TODO: Should we clean the original response if it exists?
</span><span class="c1"></span>			<span class="nx">resp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">{</span>
				<span class="nx">StatusCode</span><span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span>
				<span class="nx">Header</span><span class="p">:</span>     <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">{</span><span class="s">&#34;Retry-After&#34;</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;1&#34;</span><span class="p">}},</span>
				<span class="nx">Body</span><span class="p">:</span>       <span class="nx">ioutil</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{})),</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">done</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
			<span class="c1">// Ensure the response body is fully read and closed
</span><span class="c1"></span>			<span class="c1">// before we reconnect, so that we reuse the same TCP
</span><span class="c1"></span>			<span class="c1">// connection.
</span><span class="c1"></span>			<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="kd">const</span> <span class="nx">maxBodySlurpSize</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
				<span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="o">&lt;=</span> <span class="nx">maxBodySlurpSize</span> <span class="p">{</span>
					<span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">io</span><span class="p">.</span><span class="nx">LimitedReader</span><span class="p">{</span><span class="nx">R</span><span class="p">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">N</span><span class="p">:</span> <span class="nx">maxBodySlurpSize</span><span class="p">})</span>
				<span class="p">}</span>
				<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
			<span class="p">}()</span>

			<span class="nx">retries</span><span class="o">++</span>
			<span class="k">if</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">wait</span> <span class="o">:=</span> <span class="nf">checkWait</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">wait</span> <span class="o">&amp;&amp;</span> <span class="nx">retries</span> <span class="p">&lt;</span> <span class="nx">maxRetries</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">seeker</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">body</span><span class="p">.(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Seeker</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">body</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">seeker</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Could not retry request, can&#39;t Seek() back to beginning of body for %T&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
						<span class="nf">fn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
						<span class="k">return</span> <span class="kc">true</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Got a Retry-After %ds response for attempt %d to %v&#34;</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">retries</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">backoffMgr</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">seconds</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">false</span>
			<span class="p">}</span>
			<span class="nf">fn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">true</span>
		<span class="p">}()</span>
		<span class="k">if</span> <span class="nx">done</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="使用示例">使用示例</h4>
<p>下面的代码，列出 kube-system 命名空间下的所有 Pod 资源对象的相关信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/client-go/kubernetes/scheme&#34;</span>
	<span class="s">&#34;k8s.io/client-go/rest&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.kube/config&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">APIPath</span> <span class="p">=</span> <span class="s">&#34;api&#34;</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">GroupVersion</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">NegotiatedSerializer</span> <span class="p">=</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">Codecs</span>

	<span class="nx">restClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">RESTClientFor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">result</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span>

	<span class="nx">err</span> <span class="p">=</span> <span class="nx">restClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span>
		<span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;kube-system&#34;</span><span class="p">).</span>
		<span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;pods&#34;</span><span class="p">).</span>
		<span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">).</span>
		<span class="nf">Do</span><span class="p">().</span>
		<span class="nf">Into</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Namespace:%v \t status:%+v \t Name:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中 <code>config.NegotiatedSerializer</code> 是必须字段，主要在下面两个场景用到：</p>
<ol>
<li>在创建请求的 <code>NewRequest</code> 方法里配置 <code>Accept Header</code>；</li>
<li>在 <code>Request.transformResponse</code> 方法里用来获取解码器；</li>
<li>在 <code>Result.Into</code> 方法里解析返回值到具体的对象；</li>
</ol>
<p>示例中赋值为 <code>scheme.Codecs</code>，关键代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// 路径：staging/src/k8s.io/client-go/kubernetes/scheme/register.go
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">Codecs</span> <span class="p">=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nf">NewCodecFactory</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">)</span>

<span class="c1">// 路径：staging/src/k8s.io/apimachinery/pkg/runtime/serializer/codec_factory.go
</span><span class="c1">// NewCodecFactory provides methods for retrieving serializers for the supported wire formats
</span><span class="c1">// and conversion wrappers to define preferred internal and external versions. In the future,
</span><span class="c1">// as the internal version is used less, callers may instead use a defaulting serializer and
</span><span class="c1">// only convert objects which are shared internally (Status, common API machinery).
</span><span class="c1">// TODO: allow other codecs to be compiled in?
</span><span class="c1">// TODO: accept a scheme interface
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewCodecFactory</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="nx">CodecFactory</span> <span class="p">{</span>
	<span class="nx">serializers</span> <span class="o">:=</span> <span class="nf">newSerializersForScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">,</span> <span class="nx">json</span><span class="p">.</span><span class="nx">DefaultMetaFactory</span><span class="p">)</span>
	<span class="k">return</span> <span class="nf">newCodecFactory</span><span class="p">(</span><span class="nx">scheme</span><span class="p">,</span> <span class="nx">serializers</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 路径：staging/src/k8s.io/apimachinery/pkg/runtime/serializer/codec_factory.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newSerializersForScheme</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">mf</span> <span class="nx">json</span><span class="p">.</span><span class="nx">MetaFactory</span><span class="p">)</span> <span class="p">[]</span><span class="nx">serializerType</span> <span class="p">{</span>
	<span class="nx">jsonSerializer</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewSerializer</span><span class="p">(</span><span class="nx">mf</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
	<span class="nx">jsonPrettySerializer</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewSerializer</span><span class="p">(</span><span class="nx">mf</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
	<span class="nx">yamlSerializer</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewYAMLSerializer</span><span class="p">(</span><span class="nx">mf</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">)</span>

	<span class="nx">serializers</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">serializerType</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">AcceptContentTypes</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;application/json&#34;</span><span class="p">},</span>
			<span class="nx">ContentType</span><span class="p">:</span>        <span class="s">&#34;application/json&#34;</span><span class="p">,</span>
			<span class="nx">FileExtensions</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;json&#34;</span><span class="p">},</span>
			<span class="nx">EncodesAsText</span><span class="p">:</span>      <span class="kc">true</span><span class="p">,</span>
			<span class="nx">Serializer</span><span class="p">:</span>         <span class="nx">jsonSerializer</span><span class="p">,</span>
			<span class="nx">PrettySerializer</span><span class="p">:</span>   <span class="nx">jsonPrettySerializer</span><span class="p">,</span>

			<span class="nx">Framer</span><span class="p">:</span>           <span class="nx">json</span><span class="p">.</span><span class="nx">Framer</span><span class="p">,</span>
			<span class="nx">StreamSerializer</span><span class="p">:</span> <span class="nx">jsonSerializer</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="nx">AcceptContentTypes</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;application/yaml&#34;</span><span class="p">},</span>
			<span class="nx">ContentType</span><span class="p">:</span>        <span class="s">&#34;application/yaml&#34;</span><span class="p">,</span>
			<span class="nx">FileExtensions</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;yaml&#34;</span><span class="p">},</span>
			<span class="nx">EncodesAsText</span><span class="p">:</span>      <span class="kc">true</span><span class="p">,</span>
			<span class="nx">Serializer</span><span class="p">:</span>         <span class="nx">yamlSerializer</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">serializerExtensions</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">serializer</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">scheme</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">serializers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">serializers</span><span class="p">,</span> <span class="nx">serializer</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">serializers</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="clientset">ClientSet</h3>
<p><code>RESTClient</code> 是一种最基础的客户端，使用时需要指定 <code>Resource</code> 和 <code>Version</code> 等信息，编写代码时需要提前知道 <code>Resource</code> 所在的 <code>Group</code> 和对应的 <code>Version</code> 信息。<code>ClientSet</code> 在 <code>RESTClient</code> 的基础上封装了对 <code>Resource</code> 和 <code>Version</code> 的管理方法。每个 <code>Resource</code> 和 <code>Version</code> 都以函数的方式暴露给开发者。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>注意<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">ClientSet 仅能访问 Kubernetes 自身内置的资源（即客户端集合内的资源），不能直接访问 CRD 自定义资源。如果需要 ClientSet 访问 CRD 自定义资源，可以通过 client-gen 代码生成器重新生成 ClientSet，在 ClientSet 集合中自动生成与 CRD 操作相关的代码。</div>
        </div>
    </div>
<h4 id="创建-client">创建 client</h4>
<ol>
<li><code>NewForConfig(c *rest.Config) (*Clientset, error)</code></li>
<li><code>func NewForConfigOrDie(c *rest.Config) *Clientset</code></li>
<li><code>func New(c rest.Interface) *Clientset</code></li>
</ol>
<h4 id="使用示例-1">使用示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.kube/config&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">clientset</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfigOrDie</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

	<span class="nx">podClient</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="s">&#34;kube-system&#34;</span><span class="p">)</span>

	<span class="nx">list</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">podClient</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span> <span class="mi">500</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Namespace:%v \t status:%+v \t Name:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="dynamicclient">DynamicClient</h3>
<p><code>DynamicClient</code> 是一种动态客户端，可以对任意 Kubernetes 资源进行 RESTful 操作，包括 CRD 自定义资源。<code>DynamicClient</code> 与 <code>ClientSet</code> 最大的不同在于，<code>ClientSet</code> 需要预先实现每种 <code>Resource</code> 和 <code>Version</code> 的操作，其内部的数据都是结构化数据，而 <code>DynamicClient</code> 内部实现了 <code>Unstructured</code>，用于处理非结构化数据结构。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>注意<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">DynamicClient 不是类型安全的，因此在访问 CRD 自定义资源时需要特别注意。例如，在操作指针不当的情况下可能会导致程序崩溃。</div>
        </div>
    </div>
<p><code>DynamicClient</code> 的处理过程将 <code>Resource</code>（例如 <code>PodList</code>）转换成 <code>Unstructured</code> 结构类型，Kubernetes 的所有 <code>Resource</code> 都可以转换为该结构类型。处理完成后，再将 <code>Unstructured</code> 转换成想要的确切类型。整个过程类似于 Go 语言的 interface{} 断言转换过程。另外，<code>Unstructured</code> 结构类型是通过 <code>map[string]interface{}</code> 转换的。</p>
<h4 id="创建-client-1">创建 client</h4>
<ol>
<li>func NewForConfigOrDie(c *rest.Config) Interface</li>
<li>func NewForConfig(inConfig *rest.Config) (Interface, error)</li>
</ol>
<h4 id="使用示例-2">使用示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
	<span class="s">&#34;k8s.io/client-go/dynamic&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/root/.kube/config&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">dynamicclient</span> <span class="o">:=</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">NewForConfigOrDie</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

	<span class="nx">gvr</span> <span class="o">:=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionResource</span><span class="p">{</span><span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span> <span class="nx">Resource</span><span class="p">:</span> <span class="s">&#34;pods&#34;</span><span class="p">}</span>
	<span class="nx">unstructObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dynamicclient</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">gvr</span><span class="p">).</span><span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;kube-system&#34;</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">list</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">DefaultUnstructuredConverter</span><span class="p">.</span><span class="nf">FromUnstructured</span><span class="p">(</span><span class="nx">unstructObj</span><span class="p">.</span><span class="nf">UnstructuredContent</span><span class="p">(),</span> <span class="nx">list</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Namespace:%v \t status:%+v \t Name:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="discoveryclient">DiscoveryClient</h3>
<p><code>DiscoveryClient</code> 是发现客户端，它主要用于发现 Kubernetes API Server 所支持的资源组、资源版本、资源信息。</p>
<p><code>kubectl</code> 的 <code>api-version</code> 和 <code>api-resources</code> 命令输出也是通过 <code>DiscoveryClient</code> 实现的。另外，<code>DiscoveryClient</code> 同样是在 <code>RESTClient</code> 的基础上进行的封装。</p>
<h3 id="scaleclient">ScaleClient</h3>
<p>todo</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-08-09</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/k8s/">k8s</a>,&nbsp;<a href="/tags/client-go/">client-go</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E5%8A%9E%E5%85%AC%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="prev" rel="prev" title="办公环境设置"><i class="fas fa-angle-left fa-fw"></i>办公环境设置</a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.76.4">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">李斯文</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{"valine":{"appId":"BQfJPMph1tz4JhtlsaTUouVm-gzGzoHsz","appKey":"izuY4nGNYUWu91MvASAbUL0E","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"visitor":true}},"data":{"id-1":"李斯文的笔记本","id-2":"李斯文的笔记本"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":0,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-49242508-5', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-49242508-5" async></script></body>
</html>
